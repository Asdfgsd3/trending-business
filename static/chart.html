<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trending Businesses - Charts</title>
    <style>
      * { box-sizing: border-box; }
      body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif; 
        margin: 0; padding: 0; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #1f2937;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .nav-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .logo {
        font-size: 24px;
        font-weight: 700;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .nav-link {
        color: #667eea;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.2s;
        font-weight: 500;
      }
      .nav-link:hover {
        background: rgba(102, 126, 234, 0.1);
        transform: translateY(-1px);
      }
      h1 { 
        font-size: 32px; 
        margin: 0 0 8px 0; 
        font-weight: 700;
        color: #1f2937;
      }
      .subtitle { 
        color: #6b7280; 
        font-size: 16px;
        margin: 0;
      }
      .chart-container { 
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 24px;
      }
      .controls { 
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
      }
      .control-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .controls label { 
        font-weight: 600;
        color: #374151;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .controls select { 
        padding: 10px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        transition: border-color 0.2s;
        min-width: 160px;
      }
      .controls select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      .update-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        align-self: flex-end;
      }
      .update-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }
      .loading { 
        text-align: center; 
        padding: 60px 40px; 
        color: #6b7280;
        font-size: 16px;
      }
      .chart-wrapper {
        position: relative;
        height: 500px;
      }
      @media (max-width: 768px) {
        .container { padding: 12px; }
        .header { padding: 16px; }
        .controls { flex-direction: column; gap: 16px; }
        h1 { font-size: 24px; }
        .chart-wrapper { height: 400px; }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="nav">
          <div class="nav-left">
            <div class="logo">TrendTracker</div>
          </div>
          <div class="nav-links" style="display: flex; gap: 16px;">
            <a href="/" class="nav-link">üìä Live View</a>
            <a href="/sectors" class="nav-link">üè¢ Sectors</a>
          </div>
        </div>
        
        <h1>Historical Trending Charts</h1>
        <p class="subtitle">Interactive visualization of business trending data over the last 30 minutes</p>
      </div>

      <!-- Top 5 Trending Section -->
      <div class="chart-container">
        <h2 style="margin: 0 0 16px 0; font-size: 20px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
          üî• Top 5 Trending Companies
        </h2>
        <div id="trendingStatus" style="margin-bottom: 20px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #667eea; font-size: 14px; color: #1e40af;">
          <strong>Currently Trending:</strong> <span id="currentTrending">Loading...</span>
        </div>
        
        <div class="controls" style="margin-bottom: 16px;">
          <div class="control-group">
            <label>Metric</label>
            <select id="trendingMetricSelect" onchange="updateTrendingChart()">
              <option value="lift">Trending Factor</option>
              <option value="recent_count">Recent Mentions</option>
            </select>
          </div>
          <div style="display: flex; align-items: center; gap: 12px; color: #6b7280; font-size: 14px;">
            <span>üìä Automatically shows top 5 trending companies</span>
          </div>
        </div>
        
        <div id="trendingLoading" class="loading">Loading trending chart data...</div>
        <div class="chart-wrapper">
          <canvas id="trendingChart" style="display: none;"></canvas>
        </div>
      </div>

      <!-- Company Comparison Section -->
      <div class="chart-container">
        <h2 style="margin: 0 0 16px 0; font-size: 20px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
          üìà Company Comparison
        </h2>
        
        <div class="controls">
          <div class="control-group">
            <label>Search Companies</label>
            <input type="text" id="companySearch" placeholder="Type to search companies..." 
                   style="padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; font-size: 14px; width: 250px;">
          </div>
          <div class="control-group">
            <label>Selected Companies</label>
            <select id="companySelect" multiple size="5" onchange="updateComparisonChart()">
              <!-- Populated dynamically -->
            </select>
          </div>
          <div class="control-group">
            <label>Metric</label>
            <select id="comparisonMetricSelect" onchange="updateComparisonChart()">
              <option value="lift">Trending Factor</option>
              <option value="recent_count">Recent Mentions</option>
            </select>
          </div>
          <button class="update-btn" onclick="clearComparison()">Clear All</button>
        </div>
        
        <div id="comparisonLoading" class="loading" style="display: none;">Loading comparison chart data...</div>
        <div class="chart-wrapper">
          <canvas id="comparisonChart" style="display: none;"></canvas>
        </div>
      </div>
    </div>

    <script>
      let chartData = [];
      let allCompanies = [];
      let trendingChart = null;
      let comparisonChart = null;
      
      async function fetchChartData() {
        try {
          const res = await fetch('/api/chart_data');
          const newData = await res.json();
          
          // Check if this is new data (different from what we have)
          const isNewData = JSON.stringify(newData) !== JSON.stringify(chartData);
          
          chartData = newData;
          populateAllCompanies();
          updateTrendingChart();    // Update the top 5 trending chart
          
          document.getElementById('trendingLoading').style.display = 'none';
          document.getElementById('trendingChart').style.display = 'block';
          
          if (isNewData) {
            console.log('New trending data received, charts updated');
            showUpdateIndicator();
          }
        } catch (error) {
          document.getElementById('trendingLoading').textContent = 'Error loading chart data: ' + error.message;
        }
      }
      
      function populateAllCompanies() {
        const companies = new Set();
        
        chartData.forEach(entry => {
          Object.keys(entry.companies || {}).forEach(company => companies.add(company));
        });
        
        allCompanies = Array.from(companies).sort();
        
        // Get the latest trending companies (from most recent data point)
        const latestData = chartData.length > 0 ? chartData[chartData.length - 1] : null;
        let topTrendingCompanies = [];
        
        if (latestData && latestData.companies) {
          // Sort companies by their lift score in the latest data
          topTrendingCompanies = Object.entries(latestData.companies)
            .sort((a, b) => (b[1].lift || 0) - (a[1].lift || 0))
            .slice(0, 5)  // Top 5 trending companies
            .map(entry => entry[0]);
        }
        
        // Update the trending status display
        const statusElement = document.getElementById('currentTrending');
        if (statusElement) {
          if (topTrendingCompanies.length > 0) {
            statusElement.textContent = topTrendingCompanies.join(', ');
          } else {
            statusElement.textContent = 'No trending data available';
          }
        }
        
        // Setup search functionality
        setupCompanySearch();
        
        console.log('Top 5 trending companies:', topTrendingCompanies);
      }
      
      function setupCompanySearch() {
        const searchInput = document.getElementById('companySearch');
        const companySelect = document.getElementById('companySelect');
        
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const filteredCompanies = allCompanies.filter(company => 
            company.toLowerCase().includes(searchTerm)
          );
          
          // Update the select options with search results
          Array.from(companySelect.options).forEach(option => {
            const shouldShow = filteredCompanies.includes(option.value) || option.selected;
            option.style.display = shouldShow ? 'block' : 'none';
          });
        });
        
        // Populate the select with all companies
        companySelect.innerHTML = '';
        allCompanies.forEach(company => {
          const option = document.createElement('option');
          option.value = company;
          option.textContent = company;
          companySelect.appendChild(option);
        });
      }
      
      function updateTrendingChart() {
        const metric = document.getElementById('trendingMetricSelect').value;
        
        // Get top 5 trending companies automatically
        const latestData = chartData.length > 0 ? chartData[chartData.length - 1] : null;
        let topTrendingCompanies = [];
        
        if (latestData && latestData.companies) {
          topTrendingCompanies = Object.entries(latestData.companies)
            .sort((a, b) => (b[1].lift || 0) - (a[1].lift || 0))
            .slice(0, 5)
            .map(entry => entry[0]);
        }
        
        if (topTrendingCompanies.length === 0) {
          return;
        }
        
        // Filter data to last 30 minutes
        const now = new Date();
        const thirtyMinsAgo = new Date(now.getTime() - 30 * 60 * 1000);
        const filteredData = chartData.filter(entry => {
          const entryTime = new Date(entry.timestamp);
          return entryTime >= thirtyMinsAgo;
        });
        
        const labels = filteredData.map(entry => {
          const date = new Date(entry.timestamp);
          return date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        });
        
        const datasets = topTrendingCompanies.map((company, idx) => {
          const color = getColor(idx);
          const data = filteredData.map(entry => {
            const companyData = entry.companies?.[company];
            return companyData ? companyData[metric] : null;
          });
          
          return {
            label: company,
            data: data,
            borderColor: color,
            backgroundColor: color + '20',
            tension: 0.4,
            fill: false,
            spanGaps: true
          };
        });
        
        if (trendingChart) {
          trendingChart.data.labels = labels;
          trendingChart.data.datasets = datasets;
          trendingChart.options.scales.y.title.text = metric === 'lift' ? 'Trending Lift Factor' : 'Mention Count';
          trendingChart.options.scales.y.beginAtZero = metric === 'recent_count';
          trendingChart.options.plugins.title.text = `Top 5 Trending Companies - ${metric === 'lift' ? 'Trending Lift' : 'Mentions'}`;
          trendingChart.update();
        } else {
          const ctx = document.getElementById('trendingChart').getContext('2d');
          trendingChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
              responsive: true,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              scales: {
                x: {
                  display: true,
                  title: { display: true, text: 'Time' }
                },
                y: {
                  display: true,
                  title: { 
                    display: true, 
                    text: metric === 'lift' ? 'Trending Lift Factor' : 'Mention Count' 
                  },
                  beginAtZero: metric === 'recent_count'
                }
              },
              plugins: {
                legend: {
                  position: 'top',
                },
                title: {
                  display: true,
                  text: `Top 5 Trending Companies - ${metric === 'lift' ? 'Trending Lift' : 'Mentions'}`
                }
              }
            }
          });
        }
      }
      
      function updateComparisonChart() {
        const metric = document.getElementById('comparisonMetricSelect').value;
        const selectedCompanies = Array.from(document.getElementById('companySelect').selectedOptions)
          .map(opt => opt.value);
        
        if (selectedCompanies.length === 0) {
          // Hide chart if no companies selected
          document.getElementById('comparisonChart').style.display = 'none';
          document.getElementById('comparisonLoading').style.display = 'none';
          return;
        }
        
        document.getElementById('comparisonChart').style.display = 'block';
        
        // Filter data to last 30 minutes
        const now = new Date();
        const thirtyMinsAgo = new Date(now.getTime() - 30 * 60 * 1000);
        const filteredData = chartData.filter(entry => {
          const entryTime = new Date(entry.timestamp);
          return entryTime >= thirtyMinsAgo;
        });
        
        const labels = filteredData.map(entry => {
          const date = new Date(entry.timestamp);
          return date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        });
        
        const datasets = selectedCompanies.map((company, idx) => {
          const color = getColor(idx);
          const data = filteredData.map(entry => {
            const companyData = entry.companies?.[company];
            return companyData ? companyData[metric] : null;
          });
          
          return {
            label: company,
            data: data,
            borderColor: color,
            backgroundColor: color + '20',
            tension: 0.4,
            fill: false,
            spanGaps: true
          };
        });
        
        if (comparisonChart) {
          comparisonChart.data.labels = labels;
          comparisonChart.data.datasets = datasets;
          comparisonChart.options.scales.y.title.text = metric === 'lift' ? 'Trending Lift Factor' : 'Mention Count';
          comparisonChart.options.scales.y.beginAtZero = metric === 'recent_count';
          comparisonChart.options.plugins.title.text = `Company Comparison - ${metric === 'lift' ? 'Trending Lift' : 'Mentions'}`;
          comparisonChart.update();
        } else {
          const ctx = document.getElementById('comparisonChart').getContext('2d');
          comparisonChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
              responsive: true,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              scales: {
                x: {
                  display: true,
                  title: { display: true, text: 'Time' }
                },
                y: {
                  display: true,
                  title: { 
                    display: true, 
                    text: metric === 'lift' ? 'Trending Lift Factor' : 'Mention Count' 
                  },
                  beginAtZero: metric === 'recent_count'
                }
              },
              plugins: {
                legend: {
                  position: 'top',
                },
                title: {
                  display: true,
                  text: `Company Comparison - ${metric === 'lift' ? 'Trending Lift' : 'Mentions'}`
                }
              }
            }
          });
        }
      }
      
      function clearComparison() {
        const companySelect = document.getElementById('companySelect');
        Array.from(companySelect.options).forEach(option => option.selected = false);
        document.getElementById('companySearch').value = '';
        
        // Show all companies again
        Array.from(companySelect.options).forEach(option => {
          option.style.display = 'block';
        });
        
        updateComparisonChart();
      }
      
      function getColor(index) {
        const colors = [
          '#3b82f6', '#ef4444', '#10b981', '#f59e0b', 
          '#8b5cf6', '#06b6d4', '#84cc16', '#f97316',
          '#ec4899', '#6b7280'
        ];
        return colors[index % colors.length];
      }
      
      // Auto-refresh every 1 minute to catch trending changes quickly
      fetchChartData();
      setInterval(fetchChartData, 1000 * 60);
      
      // Also add a visual indicator when updating
      function showUpdateIndicator() {
        const indicator = document.createElement('div');
        indicator.innerHTML = 'üîÑ Updating trending companies...';
        indicator.style.cssText = `
          position: fixed; top: 20px; right: 20px; 
          background: rgba(102, 126, 234, 0.9); color: white; 
          padding: 8px 16px; border-radius: 8px; 
          font-size: 14px; z-index: 1000;
          animation: fadeInOut 2s ease-in-out;
        `;
        document.body.appendChild(indicator);
        setTimeout(() => indicator.remove(), 2000);
      }
      
      // Add CSS for the animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeInOut {
          0% { opacity: 0; transform: translateY(-10px); }
          50% { opacity: 1; transform: translateY(0); }
          100% { opacity: 0; transform: translateY(-10px); }
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>

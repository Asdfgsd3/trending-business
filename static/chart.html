<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trending Charts</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <!-- Styles -->
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .chart-wrapper {
      position: relative;
      height: 600px;
      width: 100%;
    }

    #tv-chart {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      overflow: hidden;
    }

    .legend {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 2;
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      color: #fff;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(4px);
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      pointer-events: none;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .legend-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header glass-panel">
      <div class="nav">
        <div class="nav-left">
          <div class="logo">TrendTracker</div>
        </div>
        <div class="nav-links">
          <a href="/" class="nav-link">üî• Trending</a>
          <a href="/sectors" class="nav-link">üè¢ Sectors</a>
          <a href="/chart" class="nav-link active">üìà Charts</a>
        </div>
      </div>

      <div class="hero-content">
        <h1>Trending Charts</h1>
        <p class="subtitle">Historical lift data for top trending companies</p>
      </div>
    </div>

    <div class="glass-panel" style="padding: 4px;">
      <div class="chart-wrapper">
        <div id="legend" class="legend"></div>
        <div id="tv-chart"></div>
      </div>
    </div>
  </div>

  <!-- Load Lightweight Charts library first -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

  <!-- Chart initialization script -->
  <script>
    (function () {
      'use strict';

      // Wait for library to be available
      function waitForLibrary(callback) {
        if (typeof LightweightCharts !== 'undefined') {
          callback();
        } else {
          setTimeout(() => waitForLibrary(callback), 50);
        }
      }

      // Initialize chart when library is ready
      waitForLibrary(function () {
        console.log('Lightweight Charts library loaded successfully');

        const chartContainer = document.getElementById('tv-chart');
        const legendContainer = document.getElementById('legend');

        if (!chartContainer) {
          console.error('Chart container not found');
          return;
        }

        // Create chart
        const chart = LightweightCharts.createChart(chartContainer, {
          layout: {
            background: { type: 'solid', color: '#0f172a' },
            textColor: '#94a3b8',
            fontFamily: "'Outfit', sans-serif",
          },
          grid: {
            vertLines: { color: 'rgba(255, 255, 255, 0.05)' }, // More subtle grid
            horzLines: { color: 'rgba(255, 255, 255, 0.05)' },
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
            vertLine: {
              color: 'rgba(148, 163, 184, 0.5)',
              width: 1,
              style: 3, // Dashed
              labelBackgroundColor: '#8b5cf6',
            },
            horzLine: {
              color: 'rgba(148, 163, 184, 0.5)',
              width: 1,
              style: 3, // Dashed
              labelBackgroundColor: '#8b5cf6',
            },
          },
          timeScale: {
            timeVisible: true,
            secondsVisible: false,
            borderColor: 'rgba(148, 163, 184, 0.1)',
          },
          rightPriceScale: {
            borderColor: 'rgba(148, 163, 184, 0.1)',
          },
        });

        // Handle resize
        new ResizeObserver(entries => {
          if (entries.length === 0 || entries[0].target !== chartContainer) return;
          const newRect = entries[0].contentRect;
          chart.applyOptions({ width: newRect.width, height: newRect.height });
        }).observe(chartContainer);

        const seriesMap = new Map();

        // Neon Palette: Cyan, Violet, Emerald, Amber, Rose
        const colors = [
          { line: '#22d3ee', top: 'rgba(34, 211, 238, 0.4)', bottom: 'rgba(34, 211, 238, 0.0)' }, // Cyan
          { line: '#a78bfa', top: 'rgba(167, 139, 250, 0.4)', bottom: 'rgba(167, 139, 250, 0.0)' }, // Violet
          { line: '#34d399', top: 'rgba(52, 211, 153, 0.4)', bottom: 'rgba(52, 211, 153, 0.0)' }, // Emerald
          { line: '#fbbf24', top: 'rgba(251, 191, 36, 0.4)', bottom: 'rgba(251, 191, 36, 0.0)' }, // Amber
          { line: '#f43f5e', top: 'rgba(244, 63, 94, 0.4)', bottom: 'rgba(244, 63, 94, 0.0)' }, // Rose
        ];

        async function fetchChartData() {
          try {
            const res = await fetch('/api/chart_data');
            const history = await res.json();

            if (!history || history.length === 0) {
              console.log('No chart data available');
              return;
            }

            console.log('Loaded chart data:', history.length, 'entries');

            // Get top 5 companies
            const latestEntry = history[history.length - 1];
            const topCompanies = Object.entries(latestEntry.companies)
              .sort((a, b) => b[1].lift - a[1].lift)
              .slice(0, 5)
              .map(entry => entry[0]);

            console.log('Top companies:', topCompanies);

            // Add/update series for each company
            topCompanies.forEach((company, idx) => {
              const seriesData = [];
              history.forEach(h => {
                const c = h.companies[company];
                if (c) {
                  const time = Math.floor(new Date(h.timestamp).getTime() / 1000);
                  seriesData.push({ time, value: c.lift });
                }
              });

              console.log(`${company}: ${seriesData.length} data points`);

              let series = seriesMap.get(company);
              const colorSet = colors[idx % colors.length];

              if (!series) {
                // Use AreaSeries for gradient effect
                series = chart.addAreaSeries({
                  lineColor: colorSet.line,
                  topColor: colorSet.top,
                  bottomColor: colorSet.bottom,
                  lineWidth: 2,
                  title: company,
                  priceFormat: { type: 'price', precision: 2, minMove: 0.01 },
                });
                seriesMap.set(company, series);
              }

              series.setData(seriesData);
            });

            // Remove series no longer in top 5
            const currentCompanies = new Set(topCompanies);
            seriesMap.forEach((series, company) => {
              if (!currentCompanies.has(company)) {
                chart.removeSeries(series);
                seriesMap.delete(company);
              }
            });

            updateLegend(null);

          } catch (e) {
            console.error("Failed to load chart data", e);
          }
        }

        // Update legend on crosshair move
        chart.subscribeCrosshairMove(param => {
          updateLegend(param);
        });

        function updateLegend(param) {
          if (!param || !param.time) {
            let html = '';
            seriesMap.forEach((series, name) => {
              const color = series.options().lineColor;
              html += `
                  <div class="legend-item">
                    <div class="legend-color" style="background: ${color}"></div>
                    <span>${name}</span>
                  </div>
                `;
            });
            legendContainer.innerHTML = html;
            return;
          }

          let html = '';
          seriesMap.forEach((series, name) => {
            const dataPoint = param.seriesData.get(series);
            const color = series.options().lineColor;
            if (dataPoint) {
              html += `
                  <div class="legend-item">
                    <div class="legend-color" style="background: ${color}"></div>
                    <span>${name}</span>
                    <span class="legend-value">${dataPoint.value.toFixed(2)}</span>
                  </div>
                `;
            }
          });
          legendContainer.innerHTML = html;
        }

        // Start fetching data
        fetchChartData();
        setInterval(fetchChartData, 10000);
      });
    })();
  </script>
</body>

</html>
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trending Businesses</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <!-- Styles -->
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>
  <div class="container">
    <div class="header glass-panel">
      <div class="nav">
        <div class="nav-left">
          <div class="logo">TrendTracker</div>
        </div>
        <div class="nav-links">
          <a href="/" class="nav-link active">üî• Trending</a>
          <a href="/sectors" class="nav-link">üè¢ Sectors</a>
          <a href="/chart" class="nav-link">üìà Charts</a>
        </div>
      </div>

      <div class="hero-content">
        <h1>Trending Businesses</h1>
        <p class="subtitle">Real-time business sentiment tracking from Reddit and news sources</p>
      </div>

      <div class="stats-bar">
        <div class="stat">
          <span class="stat-value" id="totalCompanies">-</span>
          <span class="stat-label">Companies Tracked</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="totalMentions">-</span>
          <span class="stat-label">Total Mentions</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="lastUpdate">-</span>
          <span class="stat-label">Last Update</span>
        </div>
      </div>
    </div>

    <div class="table-container glass-panel">
      <table id="table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Company</th>
            <th class="hide-mobile">Ticker</th>
            <th>Mentions</th>
            <th class="hide-mobile">Baseline</th>
            <th>Trending Factor</th>
            <th class="hide-mobile">Last Updated</th>
          </tr>
        </thead>
        <tbody>
          <!-- Loading State -->
          <tr>
            <td colspan="7">
              <div class="loading-container">
                <div class="spinner"></div>
                <div>Loading trending data...</div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    async function fetchData() {
      try {
        const res = await fetch('/api/trending');
        const data = await res.json();
        const tbody = document.querySelector('#table tbody');

        // Update stats
        const totalCompanies = data.length;
        const totalMentions = data.reduce((sum, row) => sum + row.recent_count, 0);
        const lastUpdate = data.length > 0 ? new Date(data[0].timestamp).toLocaleTimeString() : '-';

        document.getElementById('totalCompanies').textContent = totalCompanies;
        document.getElementById('totalMentions').textContent = Math.round(totalMentions);
        document.getElementById('lastUpdate').textContent = lastUpdate;

        // Clear loading state
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px;">No trending data available</td></tr>`;
          return;
        }

        data.forEach((row, idx) => {
          const tr = document.createElement('tr');

          // Rank styling
          let rankClass = 'rank';
          let rankColor = '';
          if (idx === 0) rankClass += ' text-neon-amber'; // Gold
          else if (idx === 1) rankClass += ' text-neon-cyan'; // Silver/Cyan
          else if (idx === 2) rankClass += ' text-neon-rose'; // Bronze/Rose

          // Lift styling
          let liftClass = 'metric';
          if (row.lift > 2) liftClass += ' text-neon-emerald';
          else if (row.lift > 1.5) liftClass += ' text-neon-cyan';
          else liftClass += ' text-neon-violet';

          const ticker = row.ticker ? `<span class="ticker">${row.ticker}</span>` : '';

          tr.innerHTML = `
              <td><span class="${rankClass}">#${idx + 1}</span></td>
              <td>
                <div class="company-cell">
                  <span class="company-name">${row.name}</span>
                  ${row.alias_used ? `<span class="badge bg-neon-violet">${row.alias_used}</span>` : ''}
                </div>
              </td>
              <td class="hide-mobile">${ticker}</td>
              <td><span class="metric">${row.recent_count.toFixed(0)}</span></td>
              <td class="hide-mobile"><span class="metric" style="color: var(--text-muted)">${row.baseline.toFixed(2)}</span></td>
              <td><span class="${liftClass}" style="font-weight: 700;">${row.lift.toFixed(2)}√ó</span></td>
              <td class="hide-mobile"><span class="timestamp">${new Date(row.timestamp).toLocaleString()}</span></td>
            `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error("Failed to fetch data", e);
      }
    }
    fetchData();
    setInterval(fetchData, 5000); // Refresh every 5s
  </script>
</body>

</html>